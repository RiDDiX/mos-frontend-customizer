name: Build and Release Frontend Customizer

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - 'page/**'
      - 'theme-loader.js'
      - 'functions'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get version from plugin.config.js
      id: version
      run: |
        VERSION=$(grep -oP "version:\s*['\"]\\K[^'\"]*" page/plugin.config.js)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Detected version: $VERSION"

    - name: Install dependencies and build
      env:
        PLUGIN_VERSION: ${{ env.VERSION }}
      run: |
        cd page
        npm install
        npm run build
        echo "Built with PLUGIN_VERSION=$PLUGIN_VERSION"
        cat dist/frontend-customizer/manifest.json

    - name: Convert line endings to LF
      run: |
        sed -i 's/\r$//' functions
        sed -i 's/\r$//' install.sh
        sed -i 's/\r$//' uninstall.sh

    - name: Create Release Archive (tar.gz)
      run: |
        mkdir -p release/frontend-customizer
        cp -r page/dist/frontend-customizer/* release/frontend-customizer/
        cp theme-loader.js release/frontend-customizer/
        cp functions release/frontend-customizer/
        cp settings.json release/frontend-customizer/
        cp install.sh release/
        cp uninstall.sh release/
        cp README.md release/
        cp LICENSE release/
        chmod +x release/install.sh release/uninstall.sh release/frontend-customizer/functions
        cd release
        tar -czf ../mos-frontend-customizer-${{ env.VERSION }}.tar.gz .
        cd ..
        md5sum mos-frontend-customizer-${{ env.VERSION }}.tar.gz | awk '{print $1}' > mos-frontend-customizer-${{ env.VERSION }}.tar.gz.md5

    - name: Create .deb Package
      run: |
        PKG_NAME="mos-frontend-customizer"
        PKG_VERSION="${{ env.VERSION }}"
        PKG_DIR="${PKG_NAME}_${PKG_VERSION}_amd64"
        
        # Create debian package structure
        mkdir -p ${PKG_DIR}/DEBIAN
        mkdir -p ${PKG_DIR}/var/www/mos-plugins/frontend-customizer
        
        # Copy plugin files
        cp -r page/dist/frontend-customizer/* ${PKG_DIR}/var/www/mos-plugins/frontend-customizer/
        cp theme-loader.js ${PKG_DIR}/var/www/mos-plugins/frontend-customizer/
        cp functions ${PKG_DIR}/var/www/mos-plugins/frontend-customizer/
        cp settings.json ${PKG_DIR}/var/www/mos-plugins/frontend-customizer/
        chmod +x ${PKG_DIR}/var/www/mos-plugins/frontend-customizer/functions
        
        # Create control file
        cat > ${PKG_DIR}/DEBIAN/control << EOF
        Package: ${PKG_NAME}
        Version: ${PKG_VERSION}
        Section: web
        Priority: optional
        Architecture: amd64
        Maintainer: RiDDiX <info@riddix.de>
        Description: Frontend Customizer - MOS
         Advanced frontend customizer with themes, branding & layout options for MOS.
         Includes 6 built-in themes, custom theme creator, branding options, and layout settings.
        EOF
        
        # Create postinst script (runs after installation)
        cat > ${PKG_DIR}/DEBIAN/postinst << 'POSTINST'
        #!/bin/bash
        INDEX_FILE="/var/www/index.html"
        LOADER_SCRIPT='<script src="/mos-plugins/frontend-customizer/theme-loader.js"></script>'
        
        if [ -f "$INDEX_FILE" ]; then
          if ! grep -q "frontend-customizer/theme-loader.js" "$INDEX_FILE"; then
            sed -i 's|<head>|<head>\n    '"$LOADER_SCRIPT"'|' "$INDEX_FILE"
          fi
        fi
        
        chmod -R 755 /var/www/mos-plugins/frontend-customizer
        exit 0
        POSTINST
        chmod 755 ${PKG_DIR}/DEBIAN/postinst
        
        # Create prerm script (runs before removal)
        cat > ${PKG_DIR}/DEBIAN/prerm << 'PRERM'
        #!/bin/bash
        INDEX_FILE="/var/www/index.html"
        
        if [ -f "$INDEX_FILE" ]; then
          sed -i '/frontend-customizer\/theme-loader.js/d' "$INDEX_FILE"
        fi
        exit 0
        PRERM
        chmod 755 ${PKG_DIR}/DEBIAN/prerm
        
        # Build the .deb package (output to current directory)
        dpkg-deb --build ${PKG_DIR} .

    - name: Delete existing releases
      run: |
        gh release delete "v${{ env.VERSION }}" --yes || true
        git push origin :refs/tags/v${{ env.VERSION }} || true
        gh release delete "latest" --yes || true
        git push origin :refs/tags/latest || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create versioned Release
      run: |
        cat > release_notes.md << 'EOF'
        ## Frontend Customizer - MOS
        
        Advanced frontend customizer with themes, branding & layout options for MOS
        
        ### Features:
        - 6 Built-in themes
        - Custom theme creator
        - Branding options
        - Layout settings (Header/Sidebar)
        - Header Plugin Shortcuts
        
        Install via MOS Hub with template: https://github.com/RiDDiX/mos-templates
        EOF
        sed -i 's/^        //' release_notes.md
        gh release create "v${{ env.VERSION }}" \
          --title "Frontend Customizer - MOS v${{ env.VERSION }}" \
          --notes-file release_notes.md \
          ./mos-frontend-customizer-${{ env.VERSION }}.tar.gz \
          ./mos-frontend-customizer-${{ env.VERSION }}.tar.gz.md5 \
          ./mos-frontend-customizer_${{ env.VERSION }}_amd64.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create latest Release
      run: |
        cp mos-frontend-customizer-${{ env.VERSION }}.tar.gz mos-frontend-customizer-latest.tar.gz
        cp mos-frontend-customizer-${{ env.VERSION }}.tar.gz.md5 mos-frontend-customizer-latest.tar.gz.md5
        cp mos-frontend-customizer_${{ env.VERSION }}_amd64.deb mos-frontend-customizer_latest_amd64.deb
        cat > latest_notes.md << 'EOF'
        ## Frontend Customizer - MOS (Latest)
        
        This is always the latest stable release.
        
        Quick Install:
        wget https://github.com/RiDDiX/mos-frontend-customizer/releases/download/latest/mos-frontend-customizer_latest_amd64.deb
        EOF
        sed -i 's/^        //' latest_notes.md
        gh release create "latest" \
          --title "Frontend Customizer - MOS (Latest)" \
          --notes-file latest_notes.md \
          ./mos-frontend-customizer-latest.tar.gz \
          ./mos-frontend-customizer-latest.tar.gz.md5 \
          ./mos-frontend-customizer_latest_amd64.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
